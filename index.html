<!DOCTYPE html>
<html>
<body>

  <h1 align="center"> Sergejs Page </h1>

  <h1><ins>aqueue.py</ins></h1>
  
  <h3>
  
    &emsp;&emsp;<FONT color="red">import</FONT> threading<br>
    <p></p>
    &emsp;&emsp;<FONT color="red">class</FONT> <FONT color="orange">AQueue</FONT>(object):<br>
    &emsp;&emsp;&emsp;&emsp;"""Asynchronous Queue"""<br>
    &emsp;&emsp;&emsp;&emsp;<FONT color="red">def</FONT> <FONT color="purple">__init__</FONT>(self):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.lock&emsp;&emsp;&emsp;&emsp;&ensp;           <FONT color="blue">=</FONT> threading.<FONT color="orange">Lock</FONT>()<br>
    &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.data_available <FONT color="blue">=</FONT> threading.<FONT color="orange">Condition</FONT>(self.lock)<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.q&emsp;&emsp;&emsp;&emsp;&emsp;&ensp;&nbsp;              <FONT color="blue">=</FONT> []<br>
<p></p>
    &emsp;&emsp;&emsp;&emsp;<FONT color="red">def</FONT> <FONT color="purple">__str__</FONT>(self):<br>
    &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<FONT color="red">with</FONT> self.lock:<br>
    &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<FONT color="red">return</FONT> <FONT color="purple">str</FONT>(self.q)<br>
<p></p>
    &emsp;&emsp;&emsp;&emsp;<FONT color="red">def</FONT> <FONT color="purple">push</FONT>(self, x):<br>
    &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<FONT color="red">with</FONT> self.lock:<br>
            &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.q.<FONT color="purple">append</FONT>(x)<br>
            &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.data_available.<FONT color="purple">notify</FONT>()<br>
<p></p>
    &emsp;&emsp;&emsp;&emsp;<FONT color="red">def</FONT> <FONT color="purple">pop</FONT>(self):<br>
    &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<FONT color="red">with</FONT> self.lock:<br>
    &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<FONT color="red">while</FONT> <FONT color="purple">len</FONT>(self.q) <FONT color="blue"><= 0</FONT>:<br>
                &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.data_available.<FONT color="purple">wait</FONT>()<br>
    &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<FONT color="red">return</FONT> self.q.<FONT color="purple">pop</FONT>(<FONT color="blue">0</FONT>)<br>
<p></p>
    &emsp;&emsp;&emsp;&emsp;<FONT color="red">def</FONT> <FONT color="purple">iter</FONT>(self):<br>
    &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<FONT color="red">while</FONT> <FONT color="blue">True</FONT>:<br>
    &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<FONT color="red">yield</FONT> self.<FONT color="purple">pop</FONT>()<br>
  
     
  </h3>

  <h1><p></p></h1>
    <h1><p></p></h1>  
    
  <h1><ins>channel.py</ins></h1>
    
   <h3>
    
     &emsp;&emsp;<FONT color="red">import</FONT> aqueue<br>
&emsp;&emsp;<FONT color="red">import</FONT> itertools<br>
<p></p>
     &emsp;&emsp;<FONT color="red">class</FONT> <FONT color="orange">Sender</FONT>(object):<br>
     &emsp;&emsp;&emsp;&emsp;<FONT color="red">def</FONT> <FONT color="purple">__init__</FONT>(self, aq):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.aq = aq<br>
<p></p>
    &emsp;&emsp;&emsp;&emsp;<FONT color="red">def</FONT> <FONT color="purple">send</FONT>(self, x):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.aq.<FONT color="purple">push</FONT>(x)<br>
<p></p>
    &emsp;&emsp;&emsp;&emsp;<FONT color="red">def</FONT> <FONT color="purple">copy</FONT>(self):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<FONT color="red">return</FONT> <FONT color="orange">Sender</FONT>(self.aq)<br>
<p></p>
&emsp;&emsp;<FONT color="red">class</FONT> <FONT color="orange">Receiver</FONT>(object):<br>
    &emsp;&emsp;&emsp;&emsp;<FONT color="red">def</FONT> <FONT color="purple">__init__</FONT>(self, aq):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.aq = aq<br>
<p></p>
    &emsp;&emsp;&emsp;&emsp;<FONT color="red">def</FONT> <FONT color="purple">recv</FONT>(self):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<FONT color="red">return</FONT> self.aq.<FONT color="purple">pop</FONT>()<br>
<p></p>
    &emsp;&emsp;&emsp;&emsp;<FONT color="red">def</FONT> <FONT color="purple">iter</FONT>(self):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<FONT color="red">return</FONT> self.aq.<FONT color="purple">iter</FONT>()<br>
<p></p>
&emsp;&emsp;<FONT color="red">def</FONT> <FONT color="purple">channel</FONT>():<br>
    &emsp;&emsp;&emsp;&emsp;aq = aqueue.<FONT color="orange">AQueue</FONT>()<br>
    &emsp;&emsp;&emsp;&emsp;<FONT color="red">return</FONT> (<FONT color="orange">Sender</FONT>(aq), <FONT color="orange">Receiver</FONT>(aq))<br>
<p></p>
&emsp;&emsp;<FONT color="red">def</FONT> <FONT color="purple">bichannel</FONT>():<br>
    &emsp;&emsp;&emsp;&emsp;(tx0, rx0) = <FONT color="purple">channel</FONT>()<br>
    &emsp;&emsp;&emsp;&emsp;(tx1, rx1) = <FONT color="purple">channel</FONT>()<br>
    &emsp;&emsp;&emsp;&emsp;<FONT color="red">return</FONT> ((tx0, rx1), (tx1, rx0))<br>
   
    </h3> 
    
    <h1><p></p></h1>
    <h1><p></p></h1>
    
    <h1><ins>channel.py</ins></h1>
    
    <h3>
      
&emsp;&emsp;import channel<br>
&emsp;&emsp;import math<br>
&emsp;&emsp;import itertools<br>
&emsp;&emsp;import matplotlib.pyplot as plt<br>
&emsp;&emsp;import string<br>
&emsp;&emsp;import sys<br>
&emsp;&emsp;import threading<br>

&emsp;&emsp;class Event(object):<br>
    &emsp;&emsp;&emsp;&emsp;pass<br>

&emsp;&emsp;class Local(Event):<br>
    &emsp;&emsp;&emsp;&emsp;def __init__(self, timestamp, owner):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.timestamp = timestamp<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.owner&emsp;&ensp;&nbsp;     = owner<br>

    &emsp;&emsp;&emsp;&emsp;def __str__(self):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;return " {} ".format(self.owner)<br>

    &emsp;&emsp;&emsp;&emsp;def __repr__(self):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;return "Local({}, {})".format(self.timestamp, self.owner)<br>

&emsp;&emsp;class Sent(Event):<br>
    &emsp;&emsp;&emsp;&emsp;def __init__(self, timestamp, src, dst):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.timestamp = timestamp<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.src&emsp;&emsp;&emsp;&nbsp;       = src<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.dst&emsp;&emsp;&emsp;&nbsp;       = dst<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.owner&emsp;&ensp;&nbsp;      = src<br>

    &emsp;&emsp;&emsp;&emsp;def __str__(self):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;return "<{}>".format(self.dst)<br>

    &emsp;&emsp;&emsp;&emsp;def __repr__(self):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;return "Sent({}, {}, {})".format(self.timestamp, self.src, self.dst)<br>

&emsp;&emsp;class Received(Event):<br>
    &emsp;&emsp;&emsp;&emsp;def __init__(self, timestamp, src, dst):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.timestamp = timestamp<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.src&emsp;&emsp;&emsp;&nbsp;       = src<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.dst&emsp;&emsp;&emsp;&nbsp;       = dst<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.owner&emsp;&ensp;&nbsp;     = dst<br>

    &emsp;&emsp;&emsp;&emsp;def __str__(self):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;return "({})".format(self.src)<br>

    &emsp;&emsp;&emsp;&emsp;def __repr__(self):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;return "Received({}, {}, {})".format(self.timestamp, self.src, self.dst)<br>

&emsp;&emsp;class Clock_i(object):<br>
    &emsp;&emsp;&emsp;&emsp;def __init__(self, i, channels, shower_tx):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.i&emsp;&emsp;&emsp;&emsp;&nbsp;         = i<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.channels&ensp;&nbsp;  = channels<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.shower_tx = shower_tx<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.timestamp = 0<br>

    &emsp;&emsp;&emsp;&emsp;def local(self):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.shower_tx.send(Local(self.timestamp, self.i))<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.timestamp += 1<br>

    &emsp;&emsp;&emsp;&emsp;def send(self, dst):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.shower_tx.send(Sent(self.timestamp, self.i, dst))<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;(tx, _) = self.channels[dst]<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;tx.send(self.timestamp)<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.timestamp += 1<br>

    &emsp;&emsp;&emsp;&emsp;def recv(self, src):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;(_, rx) = self.channels[src]<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.timestamp = max(self.timestamp, rx.recv() + 1)<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.shower_tx.send(Received(self.timestamp, src, self.i))<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.timestamp += 1<br>

    &emsp;&emsp;&emsp;&emsp;def done_(self):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;self.shower_tx.send(None)<br>

&emsp;&emsp;def wind(fs, plotname="clock.svg"):<br>
    &emsp;&emsp;&emsp;&emsp;num_threads = len(fs)<br>
    &emsp;&emsp;&emsp;&emsp;ids = range(num_threads)<br>
    &emsp;&emsp;&emsp;&emsp;(shower_tx, shower_rx) = channel.channel()<br>
    &emsp;&emsp;&emsp;&emsp;channels = {i: {} for i in ids}<br>

    &emsp;&emsp;&emsp;&emsp;for (i, j) in itertools.combinations(ids, 2):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;(chan0, chan1) = channel.bichannel()<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;channels[i][j]&ensp; = chan0<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;channels[j][i]&ensp; = chan1<br>

    &emsp;&emsp;&emsp;&emsp;for (i, f) in enumerate(fs):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;def ticktock(f, clock):<br>
            &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;f(clock)<br>
            &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;clock.done_()<br>

        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;clock = Clock_i(i, channels[i], shower_tx.copy())<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;threading.Thread(target=ticktock, args=(f, clock)).start()<br>

    &emsp;&emsp;&emsp;&emsp;return lambda: plot(num_threads, shower_rx, plotname)<br>

&emsp;&emsp;def get_events(num_threads, shower_rx):<br>
    &emsp;&emsp;&emsp;&emsp;num_done = [0]<br>

    &emsp;&emsp;&emsp;&emsp;def more(event):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;if event is None:<br>
            &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;num_done[0] += 1<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;return num_threads != num_done[0]<br>

    &emsp;&emsp;&emsp;&emsp;events = itertools.takewhile(more, shower_rx.iter())<br>
    &emsp;&emsp;&emsp;&emsp;events = filter(lambda e: e is not None, events)<br>
    &emsp;&emsp;&emsp;&emsp;return list(events)<br>

&emsp;&emsp;def plot(num_threads, shower_rx, plotname):<br>
    &emsp;&emsp;&emsp;&emsp;events = get_events(num_threads, shower_rx)<br>

    &emsp;&emsp;&emsp;&emsp;if len(events) == 0:<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;plt.axis("off")<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;plt.savefig(plotname, bbox_inches="tight")<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;return<br>

    &emsp;&emsp;&emsp;&emsp;events = sorted(events, key=lambda e: e.timestamp)<br>
    &emsp;&emsp;&emsp;&emsp;max_timestamp = events[-1].timestamp<br>

    &emsp;&emsp;&emsp;&emsp;# horizontal lines<br>
    &emsp;&emsp;&emsp;&emsp;for i in range(max_timestamp):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;plt.plot([0, num_threads - 1], [i + 0.5, i + 0.5], "k--")<br>

    &emsp;&emsp;&emsp;&emsp;# vertical lines<br>
    &emsp;&emsp;&emsp;&emsp;for i in range(num_threads):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;plt.plot([i, i], [-0.5, max_timestamp + 0.5], "k")<br>

    &emsp;&emsp;&emsp;&emsp;# thread labels<br>
    &emsp;&emsp;&emsp;&emsp;for i in range(num_threads):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;plt.text(i, max_timestamp + 2, "process ${}$".format(string.letters[i]), rotation="vertical", horizontalalignment="center")<br>

    &emsp;&emsp;&emsp;&emsp;# event labels<br>
    &emsp;&emsp;&emsp;&emsp;for i in range(num_threads):<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;for (j, e) in enumerate(filter(lambda e: e.owner == i, events)):<br>
            &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;plt.text(e.owner - 0.1, e.timestamp, "${}_{}$".format(string.letters[i], j))<br>

    &emsp;&emsp;&emsp;&emsp;# events<br>
    &emsp;&emsp;&emsp;&emsp;while len(events) > 0:<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;e = events.pop(0)<br>

        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;if type(e) is Local:<br>
            &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;plt.scatter([e.owner], [e.timestamp], c="k")<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;elif type(e) is Sent:<br>
            &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;s = e
            &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;(x0, y0) = (s.owner, s.timestamp)<br>
            &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;r = next(e for e in events if type(e) is Received and e.src == s.src)<br>
            &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;(x1, y1)  = (r.owner, r.timestamp)<br>
            &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;plt.scatter([x0, x1], [y0, y1], c="k")<br>
            &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;plt.plot([x0, x1], [y0, y1])<br>
            &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;events.remove(r)<br>
        &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;else:<br>
            &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;pass<br>

    &emsp;&emsp;&emsp;&emsp;plt.axis("off")<br>
    &emsp;&emsp;&emsp;&emsp;plt.savefig(plotname, bbox_inches="tight")<br>
      
    </h3>
    
  
  </body>
</html>
